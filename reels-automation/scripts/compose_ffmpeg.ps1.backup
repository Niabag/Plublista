# FFmpeg Video Composition Script
# Adds branding, music, and normalizes audio for Instagram Reels

param(
    [Parameter(Mandatory=$true)]
    [string]$In,
    
    [Parameter(Mandatory=$true)]
    [string]$Out,
    
    [string]$ConfigPath = "..\config.yaml"
)

# Set UTF-8 encoding for console output
$OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# Add FFmpeg to PATH if installed via WinGet
$ffmpegPath = "$env:LOCALAPPDATA\Microsoft\WinGet\Packages\Gyan.FFmpeg_Microsoft.Winget.Source_8wekyb3d8bbwe\ffmpeg-8.0-full_build\bin"
if (Test-Path $ffmpegPath) {
    $env:Path = $env:Path + ";" + $ffmpegPath
}

Write-Host "Starting video composition..." -ForegroundColor Cyan

# Check if FFmpeg is available
try {
    $null = & ffmpeg -version 2>&1
    Write-Host "FFmpeg found" -ForegroundColor Green
} catch {
    Write-Host "ERROR: FFmpeg not found in PATH" -ForegroundColor Red
    Write-Host "Please install FFmpeg: https://ffmpeg.org/download.html" -ForegroundColor Yellow
    exit 1
}

# Check if input file exists
if (-not (Test-Path $In)) {
    Write-Host "ERROR: Input file not found: $In" -ForegroundColor Red
    exit 1
}

Write-Host "Input file: $In" -ForegroundColor Cyan
Write-Host "Output file: $Out" -ForegroundColor Cyan

# Load config (simplified - in production, parse YAML properly)
$brandLogo = "assets\brand\logo.png"
$musicTrack = "assets\music\tech-energy.mp3"

# Create output directory if it doesn't exist
$outDir = Split-Path -Parent $Out
if (-not (Test-Path $outDir)) {
    New-Item -ItemType Directory -Path $outDir -Force | Out-Null
}

# Step 1: Add brand overlay
Write-Host "ðŸ“Œ Step 1: Adding brand overlay..." -ForegroundColor Yellow
$step1 = "$outDir\step1_brand.mp4"

# DEBUG
Write-Host "   [DEBUG] Input: $In" -ForegroundColor Magenta
Write-Host "   [DEBUG] Logo: $brandLogo" -ForegroundColor Magenta
Write-Host "   [DEBUG] Output: $step1" -ForegroundColor Magenta

if (Test-Path $brandLogo) {
    Write-Host "   Adding brand logo overlay..." -ForegroundColor Cyan
    $filterComplex = '[0:v]scale=1080:-2,setsar=1[v0];[v0][1:v]overlay=16:16:format=auto[v]'
    $ffmpegArgs = @('-i', $In, '-i', $brandLogo, '-filter_complex', $filterComplex, '-map', '[v]', '-map', '0:a', '-c:v', 'libx264', '-preset', 'fast', '-pix_fmt', 'yuv420p', '-c:a', 'aac', '-b:a', '160k', $step1, '-y')
    
    Write-Host "   [DEBUG] Command: ffmpeg $($ffmpegArgs -join ' ')" -ForegroundColor DarkGray
    $output = & ffmpeg @ffmpegArgs 2>&1
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "   Brand overlay added successfully" -ForegroundColor Green
    } else {
        Write-Host "   WARNING: Brand overlay failed, continuing without it" -ForegroundColor Yellow
        Write-Host "   FFmpeg exit code: $LASTEXITCODE" -ForegroundColor Yellow
        $step1 = $In
    }
} else {
    Write-Host "   Logo not found at: $brandLogo" -ForegroundColor Yellow
    Write-Host "   Continuing without brand overlay" -ForegroundColor Yellow
    $step1 = $In
}

# Step 2: Add background music
Write-Host "ðŸŽµ Step 2: Adding background music..." -ForegroundColor Yellow
$step2 = "$outDir\step2_music.mp4"

# DEBUG
Write-Host "   [DEBUG] Input: $step1" -ForegroundColor Magenta
Write-Host "   [DEBUG] Music: $musicTrack" -ForegroundColor Magenta
Write-Host "   [DEBUG] Output: $step2" -ForegroundColor Magenta

if (Test-Path $musicTrack) {
    $audioFilter = '[1:a]volume=0.15[aBGM];[0:a][aBGM]amix=inputs=2:duration=first:dropout_transition=3,dynaudnorm'
    $ffmpegArgs = @('-i', $step1, '-i', $musicTrack, '-filter_complex', $audioFilter, '-c:v', 'copy', '-c:a', 'aac', '-b:a', '192k', $step2, '-y')
    
    Write-Host "   [DEBUG] Command: ffmpeg $($ffmpegArgs -join ' ')" -ForegroundColor DarkGray
    & ffmpeg @ffmpegArgs 2>&1 | Out-Null
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "   Background music added successfully" -ForegroundColor Green
    } else {
        Write-Host "   Skipping music due to failure" -ForegroundColor Yellow
        $step2 = $step1
    }
} else {
    Write-Host "   Music track not found, skipping" -ForegroundColor Yellow
    $step2 = $step1
}

# Step 3: Normalize loudness for Instagram
Write-Host "ðŸ”Š Step 3: Normalizing audio..." -ForegroundColor Yellow

# DEBUG: Show what file we're processing
Write-Host "   [DEBUG] Input file for step 3: $step2" -ForegroundColor Magenta
Write-Host "   [DEBUG] Output file: $Out" -ForegroundColor Magenta

# Check if step2 file exists
if (-not (Test-Path $step2)) {
    Write-Host "   ERROR: Step 2 output file not found: $step2" -ForegroundColor Red
    Write-Host "   This might mean step 2 failed silently" -ForegroundColor Yellow
    exit 1
}

$loudnormFilter = 'loudnorm=I=-16:TP=-1.5:LRA=11'
Write-Host "   Applying loudness normalization..." -ForegroundColor Cyan

# Build args array carefully
$ffmpegArgs = @(
    '-i', $step2,
    '-af', $loudnormFilter,
    '-c:v', 'copy',
    '-c:a', 'aac',
    '-b:a', '192k',
    $Out,
    '-y'
)

# DEBUG: Show the command
Write-Host "   [DEBUG] FFmpeg command:" -ForegroundColor Magenta
Write-Host "   ffmpeg $($ffmpegArgs -join ' ')" -ForegroundColor DarkGray

$output = & ffmpeg @ffmpegArgs 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "   Audio normalized successfully" -ForegroundColor Green
} else {
    Write-Host "   ERROR: Audio normalization failed" -ForegroundColor Red
    Write-Host "   FFmpeg exit code: $LASTEXITCODE" -ForegroundColor Red
    
    # DEBUG: Show full command that was attempted
    Write-Host "   [DEBUG] Failed command: ffmpeg $($ffmpegArgs -join ' ')" -ForegroundColor Magenta
    
    # Show last few lines of output
    if ($output) {
        $errorLines = $output | Select-Object -Last 10
        Write-Host "   Last error lines:" -ForegroundColor Yellow
        $errorLines | ForEach-Object { Write-Host "     $_" -ForegroundColor Gray }
    }
    exit 1
}

# Clean up intermediate files
if ($step1 -ne $In) { Remove-Item $step1 -ErrorAction SilentlyContinue }
if ($step2 -ne $step1) { Remove-Item $step2 -ErrorAction SilentlyContinue }

Write-Host ""
Write-Host "âœ¨ Video composition complete!" -ForegroundColor Green
Write-Host "   Output: $Out" -ForegroundColor Cyan

# Get video info
$duration = & ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 $Out
$size = (Get-Item $Out).Length / 1MB

Write-Host "   Duration: $([math]::Round([double]$duration, 1))s" -ForegroundColor Gray
Write-Host "   Size: $([math]::Round($size, 2)) MB" -ForegroundColor Gray
