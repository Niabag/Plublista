# Story 1.2: Database Setup & Core Schema

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a developer,
I want PostgreSQL connected via Drizzle ORM with the users table,
so that user data can be persisted and queried with type safety.

## Acceptance Criteria

1. **AC1:** Drizzle ORM connects to Neon PostgreSQL via connection string from environment variables
2. **AC2:** A `users` table is created with columns: id (UUID), email (unique), password_hash, display_name, role (enum: user/admin), subscription_tier (enum: free/starter/pro/business/agency), created_at, updated_at
3. **AC3:** Drizzle Kit generates SQL migration files from schema changes
4. **AC4:** Migrations can be applied with a single command (`npm run db:migrate`)
5. **AC5:** `db/index.ts` exports a typed Drizzle client
6. **AC6:** The schema is defined in `db/schema/users.ts` following snake_case naming conventions

## Tasks / Subtasks

- [x] **Task 1: Install Drizzle ORM + Neon driver** (AC: #1)
  - [x] Add `drizzle-orm` and `@neondatabase/serverless` to `apps/api` dependencies
  - [x] Add `drizzle-kit` and `dotenv` to `apps/api` devDependencies
  - [x] Run `npm install` from root to resolve workspace dependencies

- [x] **Task 2: Create Drizzle configuration** (AC: #3)
  - [x] Create `apps/api/drizzle.config.ts` with PostgreSQL dialect, schema path, migrations output dir
  - [x] Point `dbCredentials.url` to `process.env.DATABASE_URL`

- [x] **Task 3: Create database connection module** (AC: #1, #5)
  - [x] Create `apps/api/src/db/index.ts` with Neon HTTP client + Drizzle instance
  - [x] Export typed `db` client
  - [x] Import schema for relational query support

- [x] **Task 4: Create users schema with enums** (AC: #2, #6)
  - [x] Create `apps/api/src/db/schema/users.ts` with `pgEnum` for role and subscription_tier
  - [x] Define `users` table with all required columns (id UUID, email unique, password_hash, display_name, role, subscription_tier, created_at, updated_at)
  - [x] Create `apps/api/src/db/schema/index.ts` barrel export

- [x] **Task 5: Add database scripts to package.json** (AC: #3, #4)
  - [x] Add `db:generate` script → `drizzle-kit generate`
  - [x] Add `db:migrate` script → `drizzle-kit migrate`
  - [x] Add `db:push` script → `drizzle-kit push` (for dev prototyping)
  - [x] Add `db:studio` script → `drizzle-kit studio`

- [x] **Task 6: Generate initial migration** (AC: #3)
  - [x] Run `npx drizzle-kit generate` to create the initial SQL migration file
  - [x] Verify the generated SQL contains CREATE TYPE and CREATE TABLE statements

- [x] **Task 7: Create database connection test** (AC: #1)
  - [x] Create `apps/api/src/db/db.test.ts` with Vitest test verifying schema exports exist
  - [x] Test that the `users` table schema has all expected columns
  - [x] Run tests with `npm run test` from apps/api

- [x] **Task 8: Update .env.example and shared types** (AC: #1)
  - [x] Ensure `DATABASE_URL` is documented in root `.env.example`
  - [x] Add `user.types.ts` to `packages/shared/src/types/` with `User`, `UserRole`, `SubscriptionTier` types
  - [x] Update `packages/shared/src/index.ts` barrel export
  - [x] Rebuild shared package

- [x] **Task 9: Final verification**
  - [x] Run `npm run lint` — no errors
  - [x] Run `npm run test` — all tests pass
  - [x] Run `npm run build` — all workspaces build
  - [x] Verify drizzle-kit generate produces correct SQL

## Dev Notes

### Critical Architecture Decisions

This story establishes the database layer for the ENTIRE project. Every subsequent story depends on the patterns set here. The schema naming, Drizzle client export, and migration workflow will be reused by all 32 remaining stories.

**Source:** [architecture.md](_bmad-output/planning-artifacts/architecture.md) — Sections: "Data Architecture", "Naming Patterns", "Structure Patterns"

### Project Structure Notes

This story creates files within the existing monorepo established in Story 1.1. The database code lives in `apps/api/src/db/`:

```
apps/api/
├── drizzle.config.ts              # NEW — Drizzle Kit configuration
├── package.json                   # MODIFIED — add dependencies + scripts
├── src/
│   ├── db/                        # NEW — Database layer
│   │   ├── index.ts               # Drizzle client + Neon connection
│   │   ├── schema/
│   │   │   ├── users.ts           # Users table + enums
│   │   │   └── index.ts           # Barrel export of all schemas
│   │   └── db.test.ts             # Schema validation test
│   ├── app.ts                     # EXISTING — no changes
│   └── index.ts                   # EXISTING — no changes
├── migrations/                    # NEW — Generated by drizzle-kit
│   └── 0000_*.sql                 # Initial migration (auto-generated)
packages/shared/
├── src/
│   ├── types/
│   │   ├── api.types.ts           # EXISTING
│   │   └── user.types.ts          # NEW — User type definitions
│   └── index.ts                   # MODIFIED — add user types export
```

### Naming Conventions (MUST FOLLOW)

**Database naming — ALL snake_case:**
- Tables: plural → `users`, `content_items`, `publish_jobs`
- Columns: `snake_case` → `user_id`, `created_at`, `subscription_tier`, `password_hash`
- Enums: `snake_case` → `user_role`, `subscription_tier`
- Foreign keys: `{singular_table}_id` → `user_id`, `content_item_id`
- Indexes: `idx_{table}_{columns}` → `idx_users_email`

**Drizzle column mapping — explicit column names:**
```typescript
// ALWAYS pass the SQL column name as the first argument
email: text('email').notNull().unique(),
passwordHash: text('password_hash').notNull(),
displayName: text('display_name').notNull(),
createdAt: timestamp('created_at').defaultNow().notNull(),
```

**TypeScript property names — camelCase** (Drizzle auto-maps):
```typescript
// In TypeScript: user.passwordHash
// In PostgreSQL: password_hash
```

[Source: architecture.md § "Naming Patterns"]

### API Response Format Awareness

The health endpoint established in Story 1.1 uses `{ data: { ... } }` wrapper. Future endpoints querying users will follow the same pattern:

```typescript
// GET /api/users/me → { data: { id, email, displayName, role, subscriptionTier } }
// password_hash is NEVER returned in API responses
```

[Source: architecture.md § "Format Patterns"]

## Technical Requirements

### Library Versions (Verified February 2026)

| Library | Architecture Version | Latest Stable | Use |
|---------|---------------------|---------------|-----|
| **Drizzle ORM** | Latest | **0.45.1** | SQL-first ORM, TypeScript-native |
| **Drizzle Kit** | Latest | **0.31.9** | Migration generator + studio |
| **@neondatabase/serverless** | Latest | **1.0.2** | Neon PostgreSQL driver |
| **drizzle-zod** | Latest | **Deprecated** | Use `drizzle-orm/zod` instead (integrated) |
| **PostgreSQL** | 16 | **16** | Via Neon serverless |

### Critical Version Changes from Architecture Doc

1. **drizzle-zod is deprecated:** The separate `drizzle-zod` package has been consolidated into `drizzle-orm/zod`. Import `createInsertSchema`, `createSelectSchema` from `drizzle-orm/zod` instead.

2. **Drizzle Relations V2:** The new `defineRelations()` API replaces per-table `relations()` calls. Not needed in this story (only one table), but be aware for future stories.

3. **UUID generation:** Use `uuid().defaultRandom().primaryKey()` which maps to PostgreSQL `gen_random_uuid()`. Do NOT use `crypto.randomUUID()` (application-level) — let the database handle it.

4. **Neon HTTP driver:** Use `drizzle-orm/neon-http` with `neon()` client for simplicity. Works well even for persistent Express servers — Neon handles connection pooling server-side.

5. **Index API redesigned in Drizzle Kit 0.31.0:** `.asc()`, `.desc()`, `.nullsFirst()`, `.nullsLast()` are now per-column, not per-index. The unique constraint on email should use `.unique()` on the column directly.

## Architecture Compliance

### Patterns to Follow in This Story

1. **Schema location:** `apps/api/src/db/schema/` — one file per table (or per domain group)
2. **Client export:** `apps/api/src/db/index.ts` exports typed `db` client
3. **snake_case for ALL database identifiers** — no exceptions
4. **Enums via `pgEnum()`** — creates actual PostgreSQL ENUM types
5. **UUID primary keys** — `uuid().defaultRandom().primaryKey()` using `gen_random_uuid()`
6. **Timestamps:** `created_at` with `defaultNow()`, `updated_at` with `defaultNow()` (application updates on save)
7. **Shared types** in `packages/shared/src/types/` — consumed by both frontend and backend

### Anti-Patterns to Avoid

- DO NOT use `serial` or `integer` for primary keys — use UUID
- DO NOT use `text` for enum columns — use `pgEnum()` for type safety
- DO NOT store the Drizzle schema in `packages/shared` — it stays in `apps/api/src/db/`
- DO NOT use `drizzle-zod` as a separate package — use `drizzle-orm/zod`
- DO NOT hardcode the DATABASE_URL — always read from `process.env`
- DO NOT create relations in this story — only the `users` table
- DO NOT add `password_hash` to shared types — it must NEVER be exposed outside the backend
- DO NOT use `pg` package — use `@neondatabase/serverless` (Neon's native driver)
- DO NOT put migration files in `.gitignore` — they MUST be committed

## File Structure Requirements

### drizzle.config.ts (apps/api/)

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/db/schema/index.ts',
  out: './migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

### db/index.ts (apps/api/src/db/)

```typescript
import { drizzle } from 'drizzle-orm/neon-http';
import { neon } from '@neondatabase/serverless';
import * as schema from './schema/index.js';

const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle({ client: sql, schema });
```

### db/schema/users.ts (apps/api/src/db/schema/)

```typescript
import { pgTable, pgEnum, uuid, text, timestamp } from 'drizzle-orm/pg-core';

export const userRoleEnum = pgEnum('user_role', ['user', 'admin']);

export const subscriptionTierEnum = pgEnum('subscription_tier', [
  'free',
  'starter',
  'pro',
  'business',
  'agency',
]);

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  email: text('email').notNull().unique(),
  passwordHash: text('password_hash').notNull(),
  displayName: text('display_name').notNull(),
  role: userRoleEnum('role').default('user').notNull(),
  subscriptionTier: subscriptionTierEnum('subscription_tier').default('free').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});
```

### db/schema/index.ts (apps/api/src/db/schema/)

```typescript
export * from './users.js';
```

### packages/shared/src/types/user.types.ts

```typescript
export type UserRole = 'user' | 'admin';

export type SubscriptionTier = 'free' | 'starter' | 'pro' | 'business' | 'agency';

export interface User {
  id: string;
  email: string;
  displayName: string;
  role: UserRole;
  subscriptionTier: SubscriptionTier;
  createdAt: string;
  updatedAt: string;
}
```

**IMPORTANT:** `passwordHash` is intentionally omitted from the shared `User` type. It must NEVER be exposed outside the backend.

### apps/api/package.json scripts (additions)

```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:migrate": "drizzle-kit migrate",
    "db:push": "drizzle-kit push",
    "db:studio": "drizzle-kit studio"
  }
}
```

### .env.example (root — update existing)

Ensure the DATABASE_URL line uses Neon format:
```bash
# Database (Neon PostgreSQL)
DATABASE_URL=postgresql://user:password@ep-xxx-yyy.eu-central-1.aws.neon.tech/plublista?sslmode=require
```

## Testing Requirements

- Create `apps/api/src/db/db.test.ts` — unit test verifying:
  - Schema exports (`users` table, `userRoleEnum`, `subscriptionTierEnum`) are defined
  - `users` table has all expected columns (id, email, passwordHash, displayName, role, subscriptionTier, createdAt, updatedAt)
  - Enum values are correct
- Do NOT test actual database connection in unit tests (requires a running Neon instance)
- The migration file generated by `drizzle-kit generate` serves as integration verification
- Existing tests (`apps/api/src/app.test.ts` — health endpoint) must continue to pass

## Previous Story Intelligence

### From Story 1.1: Initialize Monorepo & Development Infrastructure

**Key learnings applied:**
- ESLint 9 (not 10) — peer dependency issue with eslint-plugin-react. Already resolved.
- Root `package.json` has `"type": "module"` — all imports must use `.js` extension in compiled output
- Build order: `packages/shared` → `apps/api` → `apps/web`
- Test framework: Vitest with supertest for API tests
- Missing dependencies were caught during npm install — be thorough with deps

**Files created that this story touches:**
- `apps/api/package.json` — add Drizzle + Neon dependencies and db scripts
- `.env.example` — update DATABASE_URL format
- `packages/shared/src/index.ts` — add user types export
- `packages/shared/src/types/` — add user.types.ts

**Patterns established:**
- Express app in `apps/api/src/app.ts` with health endpoint
- Tests co-located in `apps/api/src/` using Vitest
- Shared types barrel-exported from `packages/shared/src/index.ts`

## References

- [Source: architecture.md § "Data Architecture"] — PostgreSQL via Neon, Drizzle ORM, Drizzle Kit migrations
- [Source: architecture.md § "Naming Patterns"] — snake_case for database, camelCase for TypeScript
- [Source: architecture.md § "Structure Patterns"] — `apps/api/src/db/schema/` location, barrel exports
- [Source: architecture.md § "Core Architectural Decisions"] — Neon PostgreSQL 16, Drizzle ORM latest
- [Source: epics.md § "Story 1.2"] — Acceptance criteria, users table columns
- [Source: prd.md § "Tenant Model"] — Row-level isolation via user_id, subscription tiers
- [Source: prd.md § "RBAC & Permission Matrix"] — User roles (user, admin)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

- Drizzle Kit uses CJS internally (`bin.cjs`), so `.js` extensions in TypeScript barrel exports cause `MODULE_NOT_FOUND` errors. Fixed by using extensionless imports in `schema/index.ts` and `db/index.ts` (these files are only consumed by drizzle-kit and vitest, both of which handle TS resolution).
- 4 moderate severity vulnerabilities reported by npm audit (from transitive deps) — not actionable, no breaking issues.
- [Code Review] Fixed `timestamp` → `timestamp with time zone` (timestamptz) for created_at/updated_at — PostgreSQL best practice for multi-timezone SaaS.
- [Code Review] Added DATABASE_URL validation in db/index.ts — fail fast with clear error instead of cryptic neon(undefined) failure.
- [Code Review] Migration regenerated: `0000_dashing_silver_sable.sql` replaces `0000_purple_shape.sql` with timestamptz columns.

### Completion Notes List

- All 6 ACs satisfied
- 4 new Vitest tests (schema columns, SQL column mapping, role enum values, subscription tier enum values) + 2 existing health endpoint tests = 6 total passing
- Migration file `0000_dashing_silver_sable.sql` generated with correct CREATE TYPE and CREATE TABLE statements (using timestamptz)
- `passwordHash` intentionally excluded from shared `User` type (security: never exposed outside backend)
- Database connection not tested against live Neon instance (requires provisioned DB) — schema correctness verified via unit tests and migration generation

### Change Log

- Modified: apps/api/package.json — added drizzle-orm, @neondatabase/serverless, drizzle-kit, dotenv, db:* scripts
- Created: apps/api/drizzle.config.ts
- Created: apps/api/src/db/index.ts — with DATABASE_URL validation
- Created: apps/api/src/db/schema/users.ts — using timestamptz for timestamps
- Created: apps/api/src/db/schema/index.ts
- Created: apps/api/src/db/db.test.ts
- Created: apps/api/migrations/0000_dashing_silver_sable.sql
- Created: apps/api/migrations/meta/_journal.json
- Created: apps/api/migrations/meta/0000_snapshot.json
- Modified: .env.example — updated DATABASE_URL to Neon format
- Created: packages/shared/src/types/user.types.ts
- Modified: packages/shared/src/index.ts — added User, UserRole, SubscriptionTier exports

### File List

- apps/api/package.json
- apps/api/drizzle.config.ts
- apps/api/src/db/index.ts
- apps/api/src/db/schema/users.ts
- apps/api/src/db/schema/index.ts
- apps/api/src/db/db.test.ts
- apps/api/migrations/0000_dashing_silver_sable.sql
- apps/api/migrations/meta/_journal.json
- apps/api/migrations/meta/0000_snapshot.json
- .env.example
- packages/shared/src/types/user.types.ts
- packages/shared/src/index.ts
